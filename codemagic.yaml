workflows:
  build_and_send_errors:
    name: Build & Send Errors
    max_build_duration: 60

    environment:
      vars:
        TELEGRAM_BOT_TOKEN:
          value: "Ø¶Ø¹_Ù‡Ù†Ø§_ØªÙˆÙƒÙ†_Ø§Ù„Ø¨ÙˆØª"
          is_secret: true
        TELEGRAM_CHAT_ID:
          value: "Ø¶Ø¹_Ù‡Ù†Ø§_Ø±Ù‚Ù…_Ø§Ù„Ø´Ø§Øª"
          is_secret: true

    scripts:
      - name: Build Android app
        script: |
          echo "ğŸ”¹ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
          ./gradlew assembleDebug

      - name: Save full log
        script: |
          LOG_FILE="$CM_BUILD_DIR/build_full_log.txt"
          echo "ğŸ”¹ Ø­ÙØ¸ Ø§Ù„Ù„ÙˆØ¬ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ $LOG_FILE"
          ./gradlew assembleDebug --console=plain | tee "$LOG_FILE"

      - name: Send build errors to Telegram
        script: |
          #!/usr/bin/env bash
          set -euo pipefail

          LOG_FILE="$CM_BUILD_DIR/build_full_log.txt"
          BOT_TOKEN="$TELEGRAM_BOT_TOKEN"
          CHAT_ID="$TELEGRAM_CHAT_ID"

          ERRORS=$(grep -iE "FAILURE|FATAL|Exception|error" "$LOG_FILE" || echo "(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡)")

          MAX_LEN=3800
          if [ ${#ERRORS} -gt $MAX_LEN ]; then
            ERRORS="... (ØªÙ… Ø§Ù‚ØªØ·Ø§Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ...\n${ERRORS: -$MAX_LEN}"
          fi

          echo "ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù„Ù‰ Telegram..."
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="âš ï¸ Codemagic Build Errors:\n\n$ERRORS" \
            -d parse_mode="Markdown"

    artifacts:
      - $CM_BUILD_DIR/build_full_log.txt
