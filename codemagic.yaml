workflows:
  build_and_send_errors:
    name: Build & Send Errors
    max_build_duration: 60

    environment:
      vars:
        TELEGRAM_BOT_TOKEN:
          value: ""  # Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§
          is_secret: true
        TELEGRAM_CHAT_ID:
          value: ""  # Ø¶Ø¹ Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Øª Ù‡Ù†Ø§
          is_secret: true

    scripts:
      - name: Verify Telegram variables
        script: |
          #!/usr/bin/env bash
          set -euo pipefail
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âŒ Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ TELEGRAM_BOT_TOKEN Ùˆ TELEGRAM_CHAT_ID ÙÙŠ Environment variables"
            exit 1
          fi
          echo "âœ… Ù…ØªØºÙŠØ±Ø§Øª Telegram Ù…ÙˆØ¬ÙˆØ¯Ø©."

      - name: Build Android app
        script: |
          echo "ğŸ”¹ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
          ./gradlew assembleDebug --console=plain | tee "$CM_BUILD_DIR/build_full_log.txt"

      - name: Send build errors to Telegram
        script: |
          #!/usr/bin/env bash
          set -euo pipefail
          LOG_FILE="$CM_BUILD_DIR/build_full_log.txt"
          BOT_TOKEN="$TELEGRAM_BOT_TOKEN"
          CHAT_ID="$TELEGRAM_CHAT_ID"

          ERRORS=$(grep -iE "FAILURE|FATAL|Exception|error" "$LOG_FILE" || echo "(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡)")

          MAX_LEN=3800
          if [ ${#ERRORS} -gt $MAX_LEN ]; then
            ERRORS="... (ØªÙ… Ø§Ù‚ØªØ·Ø§Ø¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ...\n${ERRORS: -$MAX_LEN}"
          fi

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="âš ï¸ Codemagic Build Errors:\n\n$ERRORS" \
            -d parse_mode="Markdown"

    artifacts:
      - build_full_log.txt
